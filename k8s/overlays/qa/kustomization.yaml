# ============================================
# QA Environment Overlay
# ============================================
# Deploy: kubectl apply -k k8s/overlays/qa

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: notes-app-qa

resources:
  - ../../
  - namespace.yaml

namePrefix: qa-

commonLabels:
  environment: qa

patches:
  # Réplicas mínimas para QA
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: backend
      spec:
        replicas: 1
    target:
      kind: Deployment
      name: backend
  
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: frontend
      spec:
        replicas: 1
    target:
      kind: Deployment
      name: frontend

  # HPA más conservador
  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: backend-hpa
      spec:
        minReplicas: 1
        maxReplicas: 2
    target:
      kind: HorizontalPodAutoscaler
      name: backend-hpa

  - patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: frontend-hpa
      spec:
        minReplicas: 1
        maxReplicas: 2
    target:
      kind: HorizontalPodAutoscaler
      name: frontend-hpa

  # Ingress para QA
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: notes-app-ingress
        annotations:
          alb.ingress.kubernetes.io/group.name: notes-app-qa
          alb.ingress.kubernetes.io/tags: Environment=qa,Project=notes-app
    target:
      kind: Ingress
      name: notes-app-ingress
